@import '../globals.scss';
@import '../naming.scss';
@import '../functions.scss';
@import '../mixins.scss';

// Default Variables
// --------------------------------------------------
  $grid: true !default;

  // Grid Parameters
  // -------------------
  $grid-type: flexbox, floats !default;
  $grid-row-modes: gutter, columned !default;

  $grid-params: calc-grid(12, column-gap, (60px, 20px)) !default;
  $grid-media-params: (
    default: $grid-params,
    laptop: $grid-params,
    tablet: $grid-params,
    mobile: $grid-params,
  ) !default;

  // Grid Composition
  // -------------------
  $grid-set: (
    default: (columns, offsets, pushes, pulles),
    laptop: (columns, offsets, pushes, pulles),
    tablet: (columns, offsets, pushes, pulles),
    mobile: (columns, offsets, pushes, pulles),
  ) !default;


// Mixins & Functions
// --------------------------------------------------

  // Grid Elements
  // ---------------------------
  // $params list - contains 3 grid parameters: 1:columns number, 2:column width
  // and 3:gap width. For simplicity, $params should be generated by calc-grid() function.
  // $element string - name of grid element, whose styles represent its behaviour. Names start
  // with _ initialize base styles (only once) and the other can be used many times under @media rule
  @mixin grid($element, $params:null, $i:1, $type: $grid-type) {
    $column-width: null;
    $gap-width: null;
    $columns: null;
    @if length($params) > 1 {
      $columns:       nth($params, 1);
      $column-width:  nth($params, 2);
      $gap-width:     nth($params, 3);
    }

    // Row Types
    // --------------------
    @if $element==_row-floats and index($type, flexbox) {
      display: block;
      position: relative;
      box-sizing: border-box;
      padding: 0;
      @include clearfix();
    }
    @else if $element==_row-flexbox and index($type, flexbox) {
      flex-wrap: if($_left == left, wrap, wrap-reverse);
      display: flex;
      position: relative;
      box-sizing: border-box;
      padding: 0;
    }
    @else if $element==row-indent {
      margin-#{$_left}: -$gap-width * 2;
    }

    // Column Types
    // --------------------
    @else if $element==_column-floats and index($type, floats) {
      float: $_left;
      display: block;
      box-sizing: border-box;
      position: relative; // need for push, pull
      min-height:1px; // no folding on empty column
    }
    @else if $element==_column-flexbox and index($type, flexbox) {
      display: flex;
      box-sizing: border-box;
      position: relative; // need for push, pull
      flex:0 1 auto; // no folding on empty column
      min-height:1px; // no folding on empty column
    }
    @else if $element==column-width-floats and index($type, floats) {
      width: if($i==0, auto, $column-width * $i);
    }
    @else if $element==column-width-flexbox and index($type, flexbox) {
      flex-basis: if($i==0, auto, $column-width * $i);
      max-width: none;
    }
    @else if $element==column-indent {
      padding-#{$_left}: $gap-width * 2;
    }

    // Column Manipulators
    // ---------------------
    @else if $element==column-offset {
      margin-#{$_left}: $column-width * $i;
    }
    @else if $element==column-unoffset {
      margin-#{$_left}: 0;
      margin-#{$_right}: 0;
    }
    @else if $element==column-push {
      #{$_left}: $column-width * $i;
      #{$_right}: auto;
    }
    @else if $element==column-pull {
      #{$_right}: $column-width * $i;
      #{$_left}: auto;
    }
    @else if $element==column-unpush or $element==column-unpull{
      left:auto;
      right:auto;
    }
    @else if $element==column-centred {
      margin-#{$_left}: auto;
      margin-#{$_right}: auto;
    }
    @else if $element==column-uncentred {
      margin-#{$_left}: 0; //or nothing
      margin-#{$_right}: 0;
    }
  }


// Output Styles
// --------------------------------------------------
@if $grid {

  // Initialise Grid
  // ---------------
  // floats row
  .row                        { @include grid(_row-floats); }
  .row > [class*="col-"]      { @include grid(_column-floats); }

  // flexbox row
  .row-flex                   { @include grid(_row-flexbox); }
  .row-flex > [class*="col-"] { @include grid(_column-flexbox); }

  // row columned - automatically breaks child elements on columns
  @if index($grid-row-modes, columned) {
    .-columned                  { list-style:none; }
    .row.-columned > *          { @include grid(_column-floats); }
    .row-flex.-columned > *     { @include grid(_column-flexbox); }
  }

  $grid-devices: nths(map-keys($_media), indexes(map-keys($_media), map-keys($grid-set)));

  // go through each device (@media rule)
  @for $f from 1 through length($grid-devices) {
    $name:   nth($grid-devices, $f);
    $params: map-get($grid-media-params, $name);
    $prefix: _($name);

    @include media($_media, $name) {
      // Columns & Rows Modes
      // --------------------
      // row gutter - defines gutters between columns
      @if index($grid-row-modes, gutter) {
        .-gutter                    { @include grid(row-indent, $params); }
        .-gutter > [class*="col-"]  { @include grid(column-indent, $params); }
        @if index($grid-row-modes, columned) {
          .-gutter.-columned > *      { @include grid(column-indent, $params); }
        }
      }

      // columns width
      @if index(map-get($grid-set, $name), columns) {
        @for $i from 0 through nth($params, 1) {
          $idx: if($i == 0, 'auto', $i);
          .row > .#{$prefix}col-#{$idx}          { @include grid(column-width-floats, $params, $i); }
          .row-flex > .#{$prefix}col-#{$idx}     { @include grid(column-width-flexbox, $params, $i); }
          @if index($grid-row-modes, columned) {
            .row.-columned.#{$prefix}cols-#{$idx} > *      { @include grid(column-width-floats, $params, $i); }
            .row-flex.-columned.#{$prefix}cols-#{$idx} > * { @include grid(column-width-flexbox, $params, $i); }
          }
        }

        // column centering for both floats and flexbox
        .#{$prefix}centred   { @include grid(column-centred); }
        .#{$prefix}uncentred { @include grid(column-uncentred); }
        // floats additions
        @if index($grid-type, floats) {
          .row > .#{$prefix}centred   { float:none; }
          .row > .#{$prefix}uncentred { float:$_left; }
        }
      }

      // Column Offsets
      // --------------
      @if index(map-get($grid-set, $name), offsets) {
        @for $i from 1 through nth($params, 1) {
          .#{$prefix}offset-#{$i} { @include grid(column-offset, $params, $i); }
        }
        .#{$prefix}unoffset { @include grid(column-unoffset); }
      }

      // Column Push
      // ------------
      @if index(map-get($grid-set, $name), pushes) {
        @for $i from 1 through nth($params, 1) {
          .#{$prefix}push-#{$i} { @include grid(column-push, $params, $i); }
        }
        .#{$prefix}unpush { @include grid(column-unpush); }
      }

      // Column Pull
      // -----------
      @if index(map-get($grid-set, $name), pulls) {
        @for $i from 1 through nth($params, 1) {
          .#{$prefix}pull-#{$i} { @include grid(column-pull, $params, $i); }
        }
        .#{$prefix}unpull { @include grid(column-unpull); }
      }
    }
  }

} $grid: false;